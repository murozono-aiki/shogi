<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>将棋</title>
    <base target="_top">
    <link rel="icon" href="./icons/shogi.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
    <style>
      /* 全般 */
      html {
        font-family: "Noto Sans JP", sans-serif;
        font-optical-sizing: auto;
        font-weight: 500;
        font-style: normal;
        color: #333333;
      }
      body {
        margin: 0;
      }
      input, button {
        font-family: inherit;
        font-optical-sizing: inherit;
        font-weight: inherit;
        font-style: inherit;
        color: inherit;
      }
      button {
        cursor: pointer;
      }
      button:disabled {
        cursor: default;
      }

      /* 将棋盤 */
      #board_area {
        user-select: none;
      }
      #board {
        border-collapse: collapse;
        background-color: #eed789;
        outline: min(1vh, 1vw) solid #eed789;
        margin: min(1vh, 1vw);
      }
      #board td {
        border: 1px solid #333333;
        box-sizing: border-box;
        width: min(10.5vh, 10.5vw);
        height: min(10.5vh, 10.5vw);
        text-align: center;
        vertical-align: middle;
        position: relative;
      }
      #board tr:nth-child(3) td:nth-child(3)::after,
      #board tr:nth-child(3) td:nth-child(6)::after,
      #board tr:nth-child(6) td:nth-child(3)::after,
      #board tr:nth-child(6) td:nth-child(6)::after {
        content: '';
        position: absolute;
        right: max(-0.3vh, -0.3vw);
        bottom: max(-0.3vh, -0.3vw);
        box-sizing: border-box;
        width: min(0.6vh, 0.6vw);
        height: min(0.6vh, 0.6vw);
        background: #333333;
        border-radius: 50%;
      }
      .board_piece {
        width: 100%;
        height: min-content;
        font-size: min(7vh, 7vw);
        text-align: center;
        line-height: 1;
      }
      .hands {
        margin: 6px 5px;
        width: min(10vh, 10vw);
        height: min(7vh, 7vw);
      }
      .hands_piece {
        font-size: min(6vh, 6vw);
      }
      .hands_count {
        font-size: min(4vh, 4vw);
      }
      /* 操作部 */
      #manager {
        margin: 10px;
      }
      #manager button {
        background-color: white;
        margin: 5px;
        padding: 8px;
        border-radius: 3px;
        font-size: 1.1rem;
        line-height: 1;
        border-style: solid;
        writing-mode: vertical-rl;
        height: fit-content;
      }
      #manager button:focus-visible {
        outline: none;
        box-shadow: #a2a2a2 2px 2px 4px;
      }
      /* 分岐 */
      #panel {
        width: 40vh;
        height: 80vh;
        display: flex;
        flex-direction: column;
      }
      #branch {
        flex: 2;
        overflow-y: auto;
      }
      #branch > div {
        margin: 5px 0;
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
        align-items: stretch;
      }
      #branch > div > button:nth-child(1) {
        background-color: inherit;
        border: none;
        width: 100%;
        padding: 5px;
      }
      #branch > div > button:nth-child(2) {
        background-color: inherit;
        border: 1px solid #999999;
      }
      #branch > div > button:nth-child(3) {
        background-color: inherit;
        border: 1px solid #999999;
      }
      #branch > div > button:nth-child(4) {
        background-color: inherit;
        border: 1px solid #999999;
      }
      #branch > div > button {
        border-radius: 2px;
        white-space: nowrap;
        margin: 0 3px;
      }
      #branch > div > button:hover {
        background-color: #f1f1f1;
      }
      #branch > div > button:disabled {
        color: #999999;
        border-color: #999999;
        background-color: inherit;
      }
      /* 棋譜 */
      #kifu {
        flex: 3;
        overflow-y: auto;
      }
      #kifu > button {
        display: flex;
        padding: 10px 0;
        width: 100%;
        border: none;
        background-color: transparent;
      }
      #kifu > button:hover {
        background-color: #f1f1f1;
      }
      #kifu > button.notDefaultMove {
        background-color: #ffc6c6aa;
      }
      #kifu > button.notDefaultMove:hover {
        background-color: #f8dbdb;
      }
      #kifu > button > span:nth-child(1) {
        width: 3rem;
        text-align: right;
        padding-right: 0.4rem;
      }
      #kifu > button > span:nth-child(2) {
        text-align: left;
      }
      #kifu > button > span:nth-child(3) {
        text-align: left;
        padding-left: 0.5rem;
        color: #036400;
      }

      @media (min-aspect-ratio: 3/2) {
        #showPanel {
          display: none;
        }
        #closePanel {
          display: none;
        }
      }
      @media (max-aspect-ratio: 3/2) {
        #panel {
          display: none;
          position: fixed;
          background-color: #ffffffde;
          box-shadow: #a2a2a2 2px 2px 4px;
        }
        #closePanel {
          text-align: right;
          background-color: transparent;
          border: none;
          padding: 7px;
        }
      }

      #board_area {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      #first_hands_area, #second_hands_area {
        display: flex;
        height: 94.5vh;
        width: auto;
      }
      #first_hands_area {
        flex-direction: column-reverse;
      }
      #second_hands_area {
        flex-direction: column;
      }
      #first_hands, #second_hands {
        display: flex;
        align-items: center;
        flex-wrap: nowrap;
        width: fit-content;
        height: fit-content;
        background-color: #eaaf32;
        min-width: min(6vh, 6vw);
        min-height: min(6vh, 6vw);
      }
      #first_hands {
        flex-direction: column-reverse;
        margin-left: 4px;
      }
      #second_hands {
        flex-direction: column;
        margin-right: 4px;
      }
      .hands {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        align-items: flex-end;
        justify-content: space-evenly;
      }
      #second_hands .hands {
        transform: rotate(180deg);
      }
      #manager {
        display: flex;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      @media (max-aspect-ratio: 1/1) {
        #board_area {
          display: flex;
          flex-direction: column;
          flex-wrap: nowrap;
          align-items: center;
        }
        #first_hands_area, #second_hands_area {
          width: 94.5vw;
          height: auto;
        }
        #first_hands_area {
          flex-direction: row-reverse;
        }
        #second_hands_area {
          flex-direction: row;
        }
        #first_hands, #second_hands {
          display: flex;
          flex-wrap: nowrap;
          align-items: center;
          justify-content: flex-start;
        }
        #first_hands {
          flex-direction: row-reverse;
          margin-top: 4px;
        }
        #second_hands {
          flex-direction: row;
          margin-bottom: 4px;
        }
        #manager {
          display: flex;
          flex-direction: row;
          justify-content: center;
          align-items: center;
        }
        #manager button {
          writing-mode: initial;
        }
      }

      #confirm_transform {
        border-radius: 3px;
      }
      #transform_button, #not_transform_button {
        font-size: min(7vh, 7vw);
        background-color: #eed789;
        line-height: 1;
        padding: min(4vh, 4vw);
        margin: min(3vh, 3vw);
        border: none;
      }
    </style>
  </head>
  <body>
    <div id="board_area">
      <div id="second_hands_area">
        <div id="second_hands">
          <div id="hands_P" class="hands">
            <div id="hands_P_piece" class="hands_piece"></div>
            <div id="hands_P_count" class="hands_count"></div>
          </div>
          <div id="hands_L" class="hands">
            <div id="hands_L_piece" class="hands_piece"></div>
            <div id="hands_L_count" class="hands_count"></div>
          </div>
          <div id="hands_N" class="hands">
            <div id="hands_N_piece" class="hands_piece"></div>
            <div id="hands_N_count" class="hands_count"></div>
          </div>
          <div id="hands_S" class="hands">
            <div id="hands_S_piece" class="hands_piece"></div>
            <div id="hands_S_count" class="hands_count"></div>
          </div>
          <div id="hands_G" class="hands">
            <div id="hands_G_piece" class="hands_piece"></div>
            <div id="hands_G_count" class="hands_count"></div>
          </div>
          <div id="hands_B" class="hands">
            <div id="hands_B_piece" class="hands_piece"></div>
            <div id="hands_B_count" class="hands_count"></div>
          </div>
          <div id="hands_R" class="hands">
            <div id="hands_R_piece" class="hands_piece"></div>
            <div id="hands_R_count" class="hands_count"></div>
          </div>
        </div>
      </div>
      <table id="board">
        <tr>
          <td id="91"><div id="91_piece" class="board_piece"></div></td>
          <td id="81"><div id="81_piece" class="board_piece"></div></td>
          <td id="71"><div id="71_piece" class="board_piece"></div></td>
          <td id="61"><div id="61_piece" class="board_piece"></div></td>
          <td id="51"><div id="51_piece" class="board_piece"></div></td>
          <td id="41"><div id="41_piece" class="board_piece"></div></td>
          <td id="31"><div id="31_piece" class="board_piece"></div></td>
          <td id="21"><div id="21_piece" class="board_piece"></div></td>
          <td id="11"><div id="11_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="92"><div id="92_piece" class="board_piece"></div></td>
          <td id="82"><div id="82_piece" class="board_piece"></div></td>
          <td id="72"><div id="72_piece" class="board_piece"></div></td>
          <td id="62"><div id="62_piece" class="board_piece"></div></td>
          <td id="52"><div id="52_piece" class="board_piece"></div></td>
          <td id="42"><div id="42_piece" class="board_piece"></div></td>
          <td id="32"><div id="32_piece" class="board_piece"></div></td>
          <td id="22"><div id="22_piece" class="board_piece"></div></td>
          <td id="12"><div id="12_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="93"><div id="93_piece" class="board_piece"></div></td>
          <td id="83"><div id="83_piece" class="board_piece"></div></td>
          <td id="73"><div id="73_piece" class="board_piece"></div></td>
          <td id="63"><div id="63_piece" class="board_piece"></div></td>
          <td id="53"><div id="53_piece" class="board_piece"></div></td>
          <td id="43"><div id="43_piece" class="board_piece"></div></td>
          <td id="33"><div id="33_piece" class="board_piece"></div></td>
          <td id="23"><div id="23_piece" class="board_piece"></div></td>
          <td id="13"><div id="13_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="94"><div id="94_piece" class="board_piece"></div></td>
          <td id="84"><div id="84_piece" class="board_piece"></div></td>
          <td id="74"><div id="74_piece" class="board_piece"></div></td>
          <td id="64"><div id="64_piece" class="board_piece"></div></td>
          <td id="54"><div id="54_piece" class="board_piece"></div></td>
          <td id="44"><div id="44_piece" class="board_piece"></div></td>
          <td id="34"><div id="34_piece" class="board_piece"></div></td>
          <td id="24"><div id="24_piece" class="board_piece"></div></td>
          <td id="14"><div id="14_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="95"><div id="95_piece" class="board_piece"></div></td>
          <td id="85"><div id="85_piece" class="board_piece"></div></td>
          <td id="75"><div id="75_piece" class="board_piece"></div></td>
          <td id="65"><div id="65_piece" class="board_piece"></div></td>
          <td id="55"><div id="55_piece" class="board_piece"></div></td>
          <td id="45"><div id="45_piece" class="board_piece"></div></td>
          <td id="35"><div id="35_piece" class="board_piece"></div></td>
          <td id="25"><div id="25_piece" class="board_piece"></div></td>
          <td id="15"><div id="15_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="96"><div id="96_piece" class="board_piece"></div></td>
          <td id="86"><div id="86_piece" class="board_piece"></div></td>
          <td id="76"><div id="76_piece" class="board_piece"></div></td>
          <td id="66"><div id="66_piece" class="board_piece"></div></td>
          <td id="56"><div id="56_piece" class="board_piece"></div></td>
          <td id="46"><div id="46_piece" class="board_piece"></div></td>
          <td id="36"><div id="36_piece" class="board_piece"></div></td>
          <td id="26"><div id="26_piece" class="board_piece"></div></td>
          <td id="16"><div id="16_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="97"><div id="97_piece" class="board_piece"></div></td>
          <td id="87"><div id="87_piece" class="board_piece"></div></td>
          <td id="77"><div id="77_piece" class="board_piece"></div></td>
          <td id="67"><div id="67_piece" class="board_piece"></div></td>
          <td id="57"><div id="57_piece" class="board_piece"></div></td>
          <td id="47"><div id="47_piece" class="board_piece"></div></td>
          <td id="37"><div id="37_piece" class="board_piece"></div></td>
          <td id="27"><div id="27_piece" class="board_piece"></div></td>
          <td id="17"><div id="17_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="98"><div id="98_piece" class="board_piece"></div></td>
          <td id="88"><div id="88_piece" class="board_piece"></div></td>
          <td id="78"><div id="78_piece" class="board_piece"></div></td>
          <td id="68"><div id="68_piece" class="board_piece"></div></td>
          <td id="58"><div id="58_piece" class="board_piece"></div></td>
          <td id="48"><div id="48_piece" class="board_piece"></div></td>
          <td id="38"><div id="38_piece" class="board_piece"></div></td>
          <td id="28"><div id="28_piece" class="board_piece"></div></td>
          <td id="18"><div id="18_piece" class="board_piece"></div></td>
        </tr>
        <tr>
          <td id="99"><div id="99_piece" class="board_piece"></div></td>
          <td id="89"><div id="89_piece" class="board_piece"></div></td>
          <td id="79"><div id="79_piece" class="board_piece"></div></td>
          <td id="69"><div id="69_piece" class="board_piece"></div></td>
          <td id="59"><div id="59_piece" class="board_piece"></div></td>
          <td id="49"><div id="49_piece" class="board_piece"></div></td>
          <td id="39"><div id="39_piece" class="board_piece"></div></td>
          <td id="29"><div id="29_piece" class="board_piece"></div></td>
          <td id="19"><div id="19_piece" class="board_piece"></div></td>
        </tr>
      </table>
      <div id="first_hands_area">
        <div id="first_hands">
          <div id="hands_p" class="hands">
            <div id="hands_p_piece" class="hands_piece"></div>
            <div id="hands_p_count" class="hands_count"></div>
          </div>
          <div id="hands_l" class="hands">
            <div id="hands_l_piece" class="hands_piece"></div>
            <div id="hands_l_count" class="hands_count"></div>
          </div>
          <div id="hands_n" class="hands">
            <div id="hands_n_piece" class="hands_piece"></div>
            <div id="hands_n_count" class="hands_count"></div>
          </div>
          <div id="hands_s" class="hands">
            <div id="hands_s_piece" class="hands_piece"></div>
            <div id="hands_s_count" class="hands_count"></div>
          </div>
          <div id="hands_g" class="hands">
            <div id="hands_g_piece" class="hands_piece"></div>
            <div id="hands_g_count" class="hands_count"></div>
          </div>
          <div id="hands_b" class="hands">
            <div id="hands_b_piece" class="hands_piece"></div>
            <div id="hands_b_count" class="hands_count"></div>
          </div>
          <div id="hands_r" class="hands">
            <div id="hands_r_piece" class="hands_piece"></div>
            <div id="hands_r_count" class="hands_count"></div>
          </div>
        </div>
      </div>
      <div id="manager">
        <button id="last">前</button>
        <button id="next">次</button>
        <button id="showPanel">分岐・棋譜</button>
      </div>
      <div id="panel">
        <button id="closePanel">×閉じる</button>
        <div id="branch"></div>
        <div id="kifu"></div>
      </div>
    </div>
    <dialog id="confirm_transform">
      <form method="dialog">
        <button id="transform_button" type="submit"></button>
        <button id="not_transform_button" type="submit"></button>
      </form>
    </dialog>





    <script>
      String.prototype.isLowerCase = function () {
        return /^[a-z]+$/.test(this);
      };
      String.prototype.isUpperCase = function () {
        return /^[A-Z]+$/.test(this);
      };
      String.prototype.swapCase = function () {
        if (/^[a-z]+$/.test(this)) {
          return this.toUpperCase();
        } else {
          return this.toLowerCase();
        }
      };

      class ShogiEngine {
        constructor() {
          // 盤面の初期化
          this.board = [
            ["L", "N", "S", "G", "K", "G", "S", "N", "L"],
            ["", "R", "", "", "", "", "", "B", ""],
            ["P", "P", "P", "P", "P", "P", "P", "P", "P"],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["", "", "", "", "", "", "", "", ""],
            ["p", "p", "p", "p", "p", "p", "p", "p", "p"],
            ["", "b", "", "", "", "", "", "r", ""],
            ["l", "n", "s", "g", "k", "g", "s", "n", "l"]
          ];
          
          // 持ち駒の初期化
          this.hands = {
            'p': 0, 'l': 0, 'n': 0, 's': 0, 'g':0, 'b': 0, 'r': 0,
            'P': 0, 'L': 0, 'N': 0, 'S': 0, 'G':0, 'B': 0, 'R': 0
          };

          // 手番
          this.turn = true;

          // 先手の王
          this.firstKing = "k";
          // 後手の王
          this.secondKing = "K"

          // 勝者
          this.winner = 0;  // 0:未定 1:先手 -1:後手

          // 駒の動き
          this.pieceMove = {
            // 前が正（＋）、右が正（＋）、[行(縦方向), 列（横方向）]
            "p": {
              move_position: [
                [1, 0]
              ],
              move_direction: []
            },
            "t": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [0, -1],
                [0, 1],
                [-1, 0]
              ],
              move_direction: []
            },
            "l": {
              move_position: [],
              move_direction: [
                [1, 0]
              ]
            },
            "i": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [0, -1],
                [0, 1],
                [-1, 0]
              ],
              move_direction: []
            },
            "n": {
              move_position: [
                [2, -1],
                [2, 1]
              ],
              move_direction: []
            },
            "h": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [0, -1],
                [0, 1],
                [-1, 0]
              ],
              move_direction: []
            },
            "s": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [-1, -1],
                [-1, 1]
              ],
              move_direction: []
            },
            "j": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [0, -1],
                [0, 1],
                [-1, 0]
              ],
              move_direction: []
            },
            "g": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [0, -1],
                [0, 1],
                [-1, 0]
              ],
              move_direction: []
            },
            "b": {
              move_position: [],
              move_direction: [
                [1, -1],
                [1, 1],
                [-1, -1],
                [-1, 1]
              ]
            },
            "a": {
              move_position: [
                [1, 0],
                [0, -1],
                [0, 1],
                [-1, 0]
              ],
              move_direction: [
                [1, -1],
                [1, 1],
                [-1, -1],
                [-1, 1]
              ]
            },
            "r": {
              move_position: [],
              move_direction: [
                [1, 0],
                [0, -1],
                [0, 1],
                [-1, 0]
              ]
            },
            "q": {
              move_position: [
                [1, -1],
                [1, 1],
                [-1, -1],
                [-1, 1]
              ],
              move_direction: [
                [1, 0],
                [0, -1],
                [0, 1],
                [-1, 0]
              ]
            },
            "k": {
              move_position: [
                [1, -1],
                [1, 0],
                [1, 1],
                [0, -1],
                [0, 1],
                [-1, -1],
                [-1, 0],
                [-1, 1]
              ],
              move_direction: []
            }
          };
          
          // 成り駒の対応
          this.transform = {
            'p': "t",
            'l': "i",
            'n': "h",
            's': "j",
            'b': "a",
            'r': "q"
          };
          this.transform_return = {
            't': "p",
            'i': "l",
            'h': "n",
            'j': "s",
            'a': "b",
            'q': "r"
          };
          this.is_can_transform_row = {
            firstMove: [true, true, true, false, false, false, false, false, false],
            secondMove: [false, false, false, false, false, false, true, true, true]
          };

          // 表記との対応
          this.pieceName = {
            "p": "歩",
            "P": "歩",
            "t": "と",
            "T": "と",
            "l": "香",
            "L": "香",
            "i": "杏",
            "I": "杏",
            "n": "桂",
            "N": "桂",
            "h": "圭",
            "H": "圭",
            "s": "銀",
            "S": "銀",
            "j": "全",
            "J": "全",
            "g": "金",
            "G": "金",
            "b": "角",
            "B": "角",
            "a": "馬",
            "A": "馬",
            "r": "飛",
            "R": "飛",
            "q": "竜",
            "Q": "竜",
            "k": "玉",
            "K": "玉"
          };
          this.convert_row = {
            0: "一",
            1: "二",
            2: "三",
            3: "四",
            4: "五",
            5: "六",
            6: "七",
            7: "八",
            8: "九"
          }
          this.convert_col = {
            0: "９",
            1: "８",
            2: "７",
            3: "６",
            4: "５",
            5: "４",
            6: "３",
            7: "２",
            8: "１"
          }
        }

        displayBoard() {
          // 盤面と持ち駒の表示
          for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++){
              const piece = this.board[row][col];
              const element = document.getElementById("" + (9 - col) + (row + 1) + "_piece");
              if (piece != "") {
                element.textContent = this.pieceName[piece];
                if (piece.isLowerCase()) {
                  element.style.transform = "";
                } else {
                  element.style.transform = "rotate(180deg)";
                }
              } else {
                element.textContent = "";
              }
            }
          }
          for (let piece in this.hands) {
            const pieceElement = document.getElementById("hands_" + piece + "_piece");
            const countElement = document.getElementById("hands_" + piece + "_count");
            if (this.hands[piece] > 0) {
              pieceElement.textContent = this.pieceName[piece];
              countElement.textContent = this.hands[piece];
            } else {
              pieceElement.textContent = "";
              countElement.textContent = "";
            }
          }
        }

        copyBoard(board) {
          const result = [];
          for (let i = 0; i < board.length; i++) {
            result[i] = new Array(...board[i]);
          }
          return result;
        }

        /**
         * 合法手を生成する関数
         * @param {boolean} [turn] - 現在の手番
         * @param {string[][]} [useBoard] - 合法手を探索する局面
         * @return {[(number|undefined), (number|undefined), number, number, undefined|string, boolean]}
        */
        generateLegalMoves(turn, useBoard) {
          if (turn === undefined) turn = this.turn;  // 初期値
          if (useBoard === undefined) useBoard = this.board;  // 初期値

          // 合法手の生成
          let legalMoves = [];
          for (let i = 0; i < 9; i++) {
            for (let j = 0; j < 9; j++) {
              let piece = useBoard[i][j];
              if (piece == "") {
                legalMoves = legalMoves.concat(this.getDropMovesForPiece(i, j, turn));
              } else if (piece.isLowerCase() == turn) {  // 手番の駒
                let piece_kind = piece.toLowerCase()
                legalMoves = legalMoves.concat(this.getLegalMovesForPiece(i, j, piece_kind, turn, useBoard));
              }
            }
          }
          
          // 手の確認
          for (let index = 0; index < legalMoves.length; index++) {
            let board = this.copyBoard(useBoard);

            let is_drop_pawn = false;
            let is_drop_pawn_check = false;

            // 駒移動後の盤面を作成
            const [from_row, from_col, to_row, to_col, dropped_piece, whether_transform] = legalMoves[index];
            if (from_row !== undefined && from_col !== undefined) {
              // 駒を移動する場合
              let piece = useBoard[from_row][from_col];
              if (whether_transform) {  // 成る場合
                let transform_piece = this.transform[piece.toLowerCase()];
                if (piece.isLowerCase()) {
                  piece = transform_piece;
                } else {
                  piece = transform_piece.toUpperCase();
                }
              }
              board[to_row][to_col] = piece;
              board[from_row][from_col] = "";
            } else {
              // 持ち駒を打つ場合
              if (dropped_piece.isLowerCase() != turn) {
                dropped_piece = dropped_piece.swapCase();
              }
              board[to_row][to_col] = dropped_piece;
              if (dropped_piece.toLowerCase() == "p") {
                is_drop_pawn = true;
                if (turn && to_row - 1 >= 0) {
                  if (board[to_row - 1][to_col] == this.secondKing) is_drop_pawn_check = true;
                } else if (!turn && to_row + 1 < 9) {
                  if (board[to_row + 1][to_col] == this.firstKing) is_drop_pawn_check = true;
                }
              }
            }

            let check;
            // 王手の有無
            check = false;
            for (let i = 0; i < 9; i++) {
              if (check) break;
              for (let j = 0; j < 9; j++) {
                if (check) break;
                let piece = board[i][j];
                if (piece && piece.isLowerCase() != turn) {  // 手番の駒
                  let piece_kind = piece.toLowerCase();
                  const next_legalMoves = this.getLegalMovesForPiece(i, j, piece_kind, !turn, board);
                  for (let move of next_legalMoves) {
                    if (check) break;
                    if (board[move[2]][move[3]] == this.firstKing || board[move[2]][move[3]] == this.secondKing) {
                      check = true;
                      break;
                    }
                  }
                }
              }
            }
            if (check) {
              legalMoves.splice(index, 1);
              index--;
              continue;
            }

            // 二歩の有無
            check = false
            if (is_drop_pawn) {
              for (let i = 0; i < 9; i++) {
                if (check) break;
                let is_p = false;
                for (let j = 0; j < 9; j++) {
                  if (board[j][i].isLowerCase() == turn && board[j][i].toLowerCase() == "p") {
                    if (is_p) {
                      check = true;
                      break;
                    } else {
                      is_p = true;
                    }
                  }
                }
              }
            }
            if (check) {
              legalMoves.splice(index, 1);
              index--;
              continue;
            }

            // 動けない駒の有無
            check = true;
            const piece = board[to_row][to_col];
            const pieceMove = this.pieceMove[piece.toLowerCase()];
            const rowIndex = turn ? -1 :  1;
            const colIndex = turn ?  1 : -1;
            for (let position of pieceMove.move_position) {
              if (!check) break;
              const moveRow = to_row + (position[0] * rowIndex);
              const moveCol = to_col + (position[1] * colIndex);
              if (moveRow >= 0 && moveRow < 9 && moveCol >= 0 && moveCol < 9) {
                check = false;
              }
            }
            for (let direction of pieceMove.move_direction) {
              if (!check) break;
              const rowDirection = direction[0] * rowIndex;
              const colDirection = direction[1] * colIndex;
              const moveRow = to_row + rowDirection;
              const moveCol = to_col + colDirection;
              if (moveRow >= 0 && moveRow < 9 && moveCol >= 0 && moveCol < 9) {
                check = false;
              }
            }
            if (check) {
              legalMoves.splice(index, 1);
              index--;
              continue
            }

            // 打ち歩詰めの確認
            check = false
            if (is_drop_pawn_check) {
              if (this.generateLegalMoves(!turn, board).length == 0) {
                check = true
              }
            }
            if (check) {
              legalMoves.splice(index, 1);
              index--;
              continue;
            }
          }
          
          return legalMoves;
        }

        getLegalMovesForPiece(row, col, piece, turn, board) {
          if (board === undefined)  board = this.board;  // デフォルト値
          
          // 駒の移動可能な座標を返す
          const legalMoves = [];
          const pieceMove = this.pieceMove[piece.toLowerCase()];
          const transform_row = turn ? this.is_can_transform_row.firstMove : this.is_can_transform_row.secondMove;
          const rowIndex = turn ? -1 :  1;
          const colIndex = turn ?  1 : -1;
          for (let position of pieceMove.move_position) {
            const moveRow = row + (position[0] * rowIndex);
            const moveCol = col + (position[1] * colIndex);
            if (moveRow >= 0 && moveRow < 9 && moveCol >= 0 && moveCol < 9 && (!board[moveRow][moveCol] || board[moveRow][moveCol].isLowerCase() != turn)) {
              legalMoves.push([row, col, moveRow, moveCol, undefined, false]);
              if (piece.toLowerCase() in this.transform && (transform_row[row] || transform_row[moveRow])) {
                legalMoves.push([row, col, moveRow, moveCol, undefined, true]);
              }
            }
          }
          for (let direction of pieceMove.move_direction) {
            const rowDirection = direction[0] * rowIndex;
            const colDirection = direction[1] * colIndex;
            let moveRow = row;
            let moveCol = col;
            for (let i = 0; i < 9; i++) {
              moveRow += rowDirection;
              moveCol += colDirection;
              if (moveRow < 0 || moveRow >= 9 || moveCol < 0 || moveCol >= 9) break;
              if (!board[moveRow][moveCol] || board[moveRow][moveCol].isLowerCase() != turn) {
                legalMoves.push([row, col, moveRow, moveCol, undefined, false]);
                if (piece.toLowerCase() in this.transform && (transform_row[row] || transform_row[moveRow])) {
                  legalMoves.push([row, col, moveRow, moveCol, undefined, true]);
                }
              }
              if (board[moveRow][moveCol]) {
                break;
              }
            }
          }
          return legalMoves
        }

        getDropMovesForPiece(to_row, to_col, turn) {
          // 持ち駒を打つ手の生成
          const dropMoves = []
          for (let piece in this.hands) {
            if (this.hands[piece] > 0 && piece.isLowerCase() == turn) {
                dropMoves.push([undefined, undefined, to_row, to_col, piece, false]);
            }
          }
          return dropMoves;
        }

        /**
         * 王の数を数える関数
         * @param {boolean} turn - true:先手の王の数を返す false:後手の王の数を返す
         * @return {number}
        */
        countKing(turn) {
          const king = turn ? this.firstKing : this.secondKing;
          let result = 0;
          for (let row = 0; row < 9; row++) {
            for (let col = 0; col < 9; col++) {
              if (this.board[row][col] == king) result++;
            }
          }
          return result;
        }

        /**
         * 手を適用して盤面を更新
         * @param {[(number|undefined), (number|undefined), number, number, (undefined|string), boolean]} move - 手を示す配列
         * @return {{from_row:(number|undefined), from_col:(number|undefined), to_row:number, to_col:number, piece:string, dropped_piece:(undefined|string), whether_transform:boolean, take_piece:string, moveCount:number, name:string, traditional_name:string, nextIndex:number[], lastIndex:number}} - 取った駒を含む手
        */
        makeMove(move) {
          // 手を適用して盤面を更新
          /**
           * 返り値
           * @type {{from_row:(number|undefined), from_col:(number|undefined), to_row:number, to_col:number, piece:string, dropped_piece:(undefined|string), whether_transform:boolean, take_piece:string, moveCount:number, name:string, traditional_name:string, nextIndex:number[], lastIndex:number}}
          */
          let result = {};
          let [from_row, from_col, to_row, to_col, dropped_piece, whether_transform] = move;
          result.from_row = from_row;
          result.from_col = from_col;
          result.to_row = to_row;
          result.to_col = to_col;
          result.dropped_piece = dropped_piece;
          result.whether_transform = whether_transform;
          result.piece = "";
          result.take_piece = "";
          result.moveCount = 0;
          result.name = "";
          result.traditional_name = "";
          result.nextIndex = [];
          result.lastIndex = -1;

          const legalMoves = this.generateLegalMoves();

          if (from_row !== undefined && from_col !== undefined) {
            // 駒を移動する場合
            let piece = this.board[from_row][from_col];
            result.piece = piece;
            let take_piece = this.board[to_row][to_col];
            if (whether_transform) {  // 成る場合
              let transform_piece = this.transform[piece.toLowerCase()];
              if (piece.isLowerCase()) {
                piece = transform_piece;
              } else {
                piece = transform_piece.toUpperCase();
              }
            }
            this.board[to_row][to_col] = piece;
            this.board[from_row][from_col] = "";
            if (take_piece != "") {  // 持ち駒の追加
              result.take_piece = take_piece;
              if (take_piece.toLowerCase() in this.transform_return) {
                if (take_piece.isLowerCase()) {
                  take_piece = this.transform_return[take_piece.toLowerCase()];
                } else {
                  take_piece = this.transform_return[take_piece.toLowerCase()].toUpperCase();
                }
              }
              const addPieceName = take_piece.swapCase();
              if (!this.hands[addPieceName]) this.hands[addPieceName] = 0;
              this.hands[addPieceName] += 1;
            }
          } else {
            // 持ち駒を打つ場合
            result.piece = dropped_piece;
            if (dropped_piece.isLowerCase() != this.turn) {
              dropped_piece = dropped_piece.swapCase();
            }
            this.hands[dropped_piece] -= 1;
            this.board[to_row][to_col] = dropped_piece;
          }
          
          this.turn = !this.turn;  // 手番交代

          if (!this.generateLegalMoves()) {
            if (this.turn) {
              this.winner = -1  // 後手の勝ち
            } else {
              this.winner = 1  // 先手の勝ち
            }
          }
          if (this.countKing(this.turn) == 0) {
            if (this.turn) {
              this.winner = -1  // 後手の勝ち
            } else {
              this.winner = 1  // 先手の勝ち
            }
          }

          return result;
        }

        /**
         * 手を戻す
         * @param {{from_row:(number|undefined), from_col:(number|undefined), to_row:number, to_col:number, piece:string, dropped_piece:(undefined|string), whether_transform:boolean, take_piece:(undefined|string), nextIndex:number[], lastIndex:number}} move - 手
        */
        returnMove(move) {
          const {from_row, from_col, to_row, to_col, dropped_piece, whether_transform, take_piece} = move;
          if (from_row !== undefined && from_col !== undefined) {
            // 駒を移動する場合
            let piece = this.board[to_row][to_col];
            if (whether_transform) {  // 成る場合
              let transform_piece = this.transform_return[piece.toLowerCase()];
              if (piece.isLowerCase()) {
                piece = transform_piece;
              } else {
                piece = transform_piece.toUpperCase();
              }
            }
            this.board[from_row][from_col] = piece;
            this.board[to_row][to_col] = "";
            if (take_piece) {  // 持ち駒の追加
              let hand_piece = take_piece.swapCase();
              if (hand_piece.toLowerCase() in this.transform_return) {
                if (hand_piece.isLowerCase()) {
                  hand_piece = this.transform_return[hand_piece.toLowerCase()];
                } else {
                  hand_piece = this.transform_return[hand_piece.toLowerCase()].toUpperCase();
                }
              }
              this.hands[hand_piece] -= 1;
              this.board[to_row][to_col] = take_piece;
            }
          } else {
            // 持ち駒を打つ場合
            this.hands[dropped_piece] += 1;
            this.board[to_row][to_col] = "";
          }
          
          this.turn = !this.turn;  // 手番交代
        }

        playRandomMove() {
          // ランダムな手を選択して適用
          const legalMoves = this.generateLegalMoves(this.turn);
          if (legalMoves) {
            const selectedMove = legalMoves[Math.floor(Math.random() * legalMoves.length)];
            this.makeMove(selectedMove);
            return selectedMove;
          }
          return undefined;
        }
      }


      /**
       * 現在の棋譜
       * @type {{from_row:(number|undefined), from_col:(number|undefined), to_row:number, to_col:number, piece:string, dropped_piece:(undefined|string), whether_transform:boolean, take_piece:string, moveCount:number, name:string, traditional_name:string, nextIndex:number[], lastIndex:number}[]}
      */
      let currentGame = [
        {
          from_row: undefined,
          from_col: undefined,
          to_row: undefined,
          to_col: undefined,
          piece: undefined,
          dropped_piece: undefined,
          whether_transform: undefined,
          take_piece: undefined,
          moveCount: 0,
          traditional_name: "開始局面",
          nextIndex: [],
          lastIndex: -1
        }
      ];  // {from_row, from_col, to_row, to_col, dropped_piece, whether_transform, take_piece, nextIndex(array), lastIndex}
      /**
       * 現在のインデックス
       * @type {number}
      */
      let currentIndex = 0;
      
      // メインの処理
      let from_row = undefined;
      let from_col = undefined;
      let to_row = undefined;
      let to_col = undefined;
      let dropped_piece = undefined;
      let whether_transform = false;
      /**
       * 現在の局面での合法手
       * @type {[(number|undefined), (number|undefined), number, number, (string|undefined), boolean][]}
      */
      let legalMoves;

      let markedElement;

      function is_LegalMove(move) {
        for (let legalMove of legalMoves) {
          let sameMove = true;
          for (let i = 0; i < legalMove.length; i++) {
            if (move[i] !== legalMove[i]) {
              sameMove = false;
              break;
            }
          }
          if (sameMove) return true;
        }
        return false;
      }
      function is_can_transform(from_row_, from_col_, to_row_, to_col_) {
        const transformMove = [from_row_, from_col_, to_row_, to_col_, undefined, true];
        return is_LegalMove(transformMove);
      }
      function resetValue() {
        from_row = undefined;
        from_col = undefined;
        to_row = undefined;
        to_col = undefined;
        dropped_piece = undefined;
        whether_transform = false;
        if (markedElement) markedElement.style.boxShadow = "";
      }

      function makeMove() {
        const move = [from_row, from_col, to_row, to_col, dropped_piece, whether_transform];

        let newMove = true;
        for (let i = 0; i < currentGame[currentIndex].nextIndex.length; i++) {
          const move_ = currentGame[currentGame[currentIndex].nextIndex[i]];
          if (move_.from_row === from_row && move_.from_col === from_col && move_.to_row === to_row && move_.to_col === to_col && move_.dropped_piece === dropped_piece && move_.whether_transform === whether_transform) {
            newMove = false;
            nextMove(i);
            break;
          }
        }


        if (newMove && is_LegalMove(move)) {
          const record_move = shogiEngine.makeMove(move);
          shogiEngine.displayBoard();

          const record_index = currentGame.length;
          // 記録する値を追加
          // 前の手
          record_move.lastIndex = currentIndex;
          record_move.moveCount = currentGame[currentIndex].moveCount + 1;
          // 指し手の表記
          const to_name = (currentGame[currentIndex].to_row == record_move.to_row && currentGame[currentIndex].to_col == record_move.to_col) ? "同　" : shogiEngine.convert_col[record_move.to_col] + shogiEngine.convert_row[record_move.to_row];
          const pieceName = shogiEngine.pieceName[record_move.piece];
          const drop = (record_move.from_row === undefined && record_move.from_col === undefined) ? "打" : "";
          const transform = record_move.whether_transform ? "成" : "";
          const from_name = ((record_move.from_row !== undefined && record_move.from_col !== undefined) && !(currentGame[currentIndex].to_row == record_move.to_row && currentGame[currentIndex].to_col == record_move.to_col)) ? "(" + (9 - record_move.from_col) + (record_move.from_row + 1) + ")" : "";
          record_move.name = to_name + pieceName + drop + transform + from_name;

          let to_name_traditional = to_name;
          let position_traditional = "";  // 右・左
          let direction_traditional = ""; // 上・引・寄・直
          let drop_traditional = "";  // 打
          let transform_traditional = transform;  // 成・不成
          let from_name_traditional = "";  // 変則将棋用
          if (to_name_traditional == "同　") to_name_traditional = "同";
          for (let legalMove of legalMoves) {
            const [from_row_, from_col_, to_row_, to_col_, dropped_piece_, whether_transform_] = legalMove;
            if (dropped_piece_ == undefined && to_row_ == record_move.to_row && to_col_ == record_move.to_col && shogiEngine.board[from_row_][from_col_] == record_move.piece/* 同じ手も排除 */) {
              const turn = record_move.piece.isLowerCase();
              if (record_move.from_row === undefined && record_move.from_col === undefined) {
                drop_traditional = "打";
                break;  // "打"がある場合動きは１通りに決まる

              } else if (record_move.from_row == record_move.to_row && from_row_ != record_move.to_row) {
                direction_traditional = "寄";

              } else if (record_move.from_row < record_move.to_row && from_row_ >= record_move.to_row) {
                if (turn) {
                  direction_traditional = "引";
                } else {
                  direction_traditional = "上";
                }

              } else if (record_move.from_row > record_move.to_row && from_row_ <= record_move.to_row) {
                if (turn) {
                  direction_traditional = "上";
                } else {
                  direction_traditional = "引";
                }

              } else if (turn && record_move.from_col == record_move.to_col && record_move.from_row - 1 == record_move.to_row && shogiEngine.pieceMove[record_move.piece.toLowerCase()].move_direction.length == 0) {
                direction_traditional = "直";
                position_traditional = "";
                break;  // "直"がある場合動きは１通りに決まる

              } else if (!turn && record_move.from_col == record_move.to_col && record_move.from_row + 1 == record_move.to_row && shogiEngine.pieceMove[record_move.piece.toLowerCase()].move_direction.length == 0) {
                direction_traditional = "直";
                position_traditional = "";
                break;  // "直"がある場合動きは１通りに決まる

              } else if (record_move.from_col < from_col_) {
                if (turn) {
                  position_traditional = "左";
                } else {
                  position_traditional = "右";
                }

              } else if (record_move.from_col > from_col_) {
                if (turn) {
                  position_traditional = "右";
                } else {
                  position_traditional = "左";
                }

              } else {
                from_name_traditional = from_name;
              }
            }
          }
          if (!record_move.whether_transform) {
            for (let legalMove of legalMoves) {
              const [from_row_, from_col_, to_row_, to_col_, dropped_piece_, whether_transform_] = legalMove;
              if (record_move.from_row == from_row_ && record_move.from_col == from_col_ && record_move.to_row == to_row_ && record_move.to_col == to_col_ && whether_transform_ == true) {
                transform_traditional = "不成";
              }
            }
          }
          record_move.traditional_name = to_name_traditional + pieceName + position_traditional + direction_traditional + drop_traditional + transform_traditional + from_name_traditional;

          if (currentGame[currentIndex]) currentGame[currentIndex].nextIndex.push(record_index);
          currentGame[record_index] = record_move;
          currentIndex = record_index;

          if (shogiEngine.winner == 0) {
            resetValue();
            legalMoves = shogiEngine.generateLegalMoves();
          } else {
            resetValue();
            legalMoves = [];
          }
          document.getElementById("last").disabled = false;
          document.getElementById("next").disabled = true;
        } else {
          resetValue();
        }
        setBranch();
        setKifu();
      }

      function setBranch() {
        const branchElement = document.createElement('div');
        document.getElementById("branch").replaceWith(branchElement);
        branchElement.id = "branch";

        const branchIndex = currentGame[currentIndex].nextIndex;
        for (let i = 0; i < branchIndex.length; i++) {
          const index = branchIndex[i];

          const element = document.createElement('div');
          branchElement.appendChild(element);
          const nameButton = document.createElement('button');
          element.appendChild(nameButton);
          const upButton = document.createElement('button');
          element.appendChild(upButton);
          const downButton = document.createElement('button');
          element.appendChild(downButton);
          const deleteButton = document.createElement('button');
          element.appendChild(deleteButton);
          nameButton.textContent = currentGame[index].traditional_name;
          upButton.textContent = "↑";
          downButton.textContent = "↓";
          deleteButton.textContent = "削除";
          nameButton.addEventListener('click', event => {
            nextMove(i);
          });
          const arrayIndex = i;
          upButton.addEventListener('click', event => {
            const temp = currentGame[currentIndex].nextIndex[arrayIndex-1];
            currentGame[currentIndex].nextIndex[arrayIndex-1] = currentGame[currentIndex].nextIndex[arrayIndex];
            currentGame[currentIndex].nextIndex[arrayIndex] = temp;
            setBranch();
            if (arrayIndex == 1) setKifu();
          });
          if (i == 0) upButton.disabled = true;
          downButton.addEventListener('click', event => {
            const temp = currentGame[currentIndex].nextIndex[arrayIndex+1];
            currentGame[currentIndex].nextIndex[arrayIndex+1] = currentGame[currentIndex].nextIndex[arrayIndex];
            currentGame[currentIndex].nextIndex[arrayIndex] = temp;
            setBranch();
            if (arrayIndex == 0) setKifu();
          });
          if (i == branchIndex.length - 1) downButton.disabled = true;
        }
      }

      function setKifu() {
        const kifuElement = document.createElement('div');
        document.getElementById("kifu").replaceWith(kifuElement);
        kifuElement.id = "kifu";

        const createMoveElement = (_index) => {
          const moveElement = document.createElement('button');
          const moveCountElement = document.createElement('span');
          moveElement.appendChild(moveCountElement);
          moveCountElement.textContent = currentGame[_index].moveCount + ".";
          const moveNameElement = document.createElement('span');
          moveElement.appendChild(moveNameElement);
          moveNameElement.textContent = currentGame[_index].traditional_name;
          if (currentGame[_index].nextIndex.length > 1) {
            const branchCountElement = document.createElement('span');
            moveElement.appendChild(branchCountElement);
            branchCountElement.textContent = "+" + (currentGame[_index].nextIndex.length - 1);
          }
          if (currentGame[_index].lastIndex >= 0 && currentGame[currentGame[_index].lastIndex].nextIndex.indexOf(_index) != 0) {
            moveElement.classList.add("notDefaultMove");
          }
          moveElement.addEventListener('click', event => {
            const difference = currentGame[_index].moveCount - currentGame[currentIndex].moveCount;
            if (difference < 0) {
              for (let i = 0; i < Math.abs(difference); i++) {
                shogiEngine.returnMove(currentGame[currentIndex]);
                currentIndex = currentGame[currentIndex].lastIndex;
              }
              shogiEngine.displayBoard();
              moveElement.scrollIntoView({block: "center", behavior: "smooth"});
              legalMoves = shogiEngine.generateLegalMoves();
              setBranch();
              document.getElementById("next").disabled = false;
              document.getElementById("last").disabled = false;
              if (currentGame[currentIndex].lastIndex < 0) document.getElementById("last").disabled = true;
            } else if (difference > 0) {
              for (let i = 0; i < Math.abs(difference); i++) {
                const moveObject = currentGame[currentGame[currentIndex].nextIndex[0]];
                shogiEngine.makeMove([moveObject.from_row, moveObject.from_col, moveObject.to_row, moveObject.to_col, moveObject.dropped_piece, moveObject.whether_transform]);
                currentIndex = currentGame[currentIndex].nextIndex[0];
              }
              shogiEngine.displayBoard();
              moveElement.scrollIntoView({block: "center", behavior: "smooth"});
              legalMoves = shogiEngine.generateLegalMoves();
              setBranch();
              document.getElementById("last").disabled = false;
              document.getElementById("next").disabled = false;
              if (currentGame[currentIndex].nextIndex.length == 0) document.getElementById("next").disabled = true;
            } else {
              moveElement.scrollIntoView({block: "center", behavior: "smooth"});
            }
          });
          return moveElement;
        };

        let index;
        const moves = [];

        index = currentIndex;
        const currentMoveElement = createMoveElement(index)
        kifuElement.appendChild(currentMoveElement);

        index = currentGame[index].lastIndex;
        while (index >= 0) {
          const moveElement = createMoveElement(index);
          kifuElement.insertBefore(moveElement, kifuElement.firstChild);
          index = currentGame[index].lastIndex;
        }

        index = currentGame[currentIndex].nextIndex[0];
        while (index !== undefined) {
          const moveElement = createMoveElement(index);
          kifuElement.appendChild(moveElement);
          index = currentGame[index].nextIndex[0];
        }

        if (currentMoveElement) {
          currentMoveElement.scrollIntoView({block:"center"});
        }
      }

      document.getElementById("transform_button").addEventListener('click', event => {
        whether_transform = true;
        makeMove();
      });
      document.getElementById("not_transform_button").addEventListener('click', event => {
        makeMove();
      });
      function showTransformDialog() {
        const piece = shogiEngine.board[from_row][from_col];
        const pieceName = shogiEngine.pieceName[piece];
        const transformPieceName = shogiEngine.pieceName[shogiEngine.transform[piece.toLowerCase()]];
        document.getElementById("transform_button").textContent = transformPieceName;
        document.getElementById("not_transform_button").textContent = pieceName;
        if (piece.isLowerCase()) {
          document.getElementById("transform_button").style.transform = "";
          document.getElementById("not_transform_button").style.transform = "";
        } else {
          document.getElementById("transform_button").style.transform = "rotate(180deg)";
          document.getElementById("not_transform_button").style.transform = "rotate(180deg)";
        }
        document.getElementById("confirm_transform").showModal();
      }

      
      // メイン
      const shogiEngine = new ShogiEngine();
      shogiEngine.displayBoard();
      legalMoves = shogiEngine.generateLegalMoves();
      for (let i = 0; i < 9; i++) {
        for (let j = 0; j < 9; j++) {
          const row = i;
          const col = j;
          document.getElementById("" + (9 - col) + (row + 1)).addEventListener('click', event => {
            if (from_row === undefined && from_col === undefined && dropped_piece === undefined) {
              from_row = row;
              from_col = col;
              event.currentTarget.style.boxShadow = "inset #ccad00 0 0 0 min(0.5vh, 0.5vw)";
              markedElement = event.currentTarget;
            } else {
              to_row = row;
              to_col = col;
              if (!is_can_transform(from_row, from_col, to_row, to_col)) {
                makeMove();
              } else {
                showTransformDialog();
              }
            }
          });
        }
      }
      for (let key in shogiEngine.hands) {
        const piece = key;
        document.getElementById("hands_" + piece).addEventListener('click', event => {
          if (!from_row && !from_col && !dropped_piece) {
            dropped_piece = piece;
            event.currentTarget.style.boxShadow = "inset #fcd523 0 0 0 min(0.5vh, 0.5vw)";
            markedElement = event.currentTarget;
          } else {
            resetValue();
          }
        });
      }

      function lastMove() {
        if (currentGame[currentIndex] && currentGame[currentIndex].lastIndex >= 0) {
          shogiEngine.returnMove(currentGame[currentIndex]);
          shogiEngine.displayBoard();
          currentIndex = currentGame[currentIndex].lastIndex;
          resetValue();
          legalMoves = shogiEngine.generateLegalMoves();
          document.getElementById("next").disabled = false;
          if (currentGame[currentIndex].lastIndex < 0) {
            document.getElementById("last").disabled = true;
          }
          setBranch();
          setKifu();
        } else {
          document.getElementById("last").disabled = true;
        }
      }
      function nextMove(index) {
        const moveIndex = index || 0;
        if (currentGame[currentIndex] && currentGame[currentIndex].nextIndex[moveIndex] !== undefined) {
          const index = currentGame[currentIndex].nextIndex[moveIndex];
          const move = currentGame[index];
          shogiEngine.makeMove([move.from_row, move.from_col, move.to_row, move.to_col, move.dropped_piece, move.whether_transform]);
          shogiEngine.displayBoard();
          currentIndex = index;
          resetValue();
          legalMoves = shogiEngine.generateLegalMoves();
          document.getElementById("last").disabled = false;
          if (currentGame[currentIndex].nextIndex[0] === undefined) {
            document.getElementById("next").disabled = true;
          }
          setBranch();
          setKifu();
        } else {
          document.getElementById("next").disabled = true;
        }
      }
      document.getElementById("last").addEventListener('click', event => {
        lastMove();
      });
      document.getElementById("next").addEventListener('click', event => {
        nextMove(0);
      });
      document.getElementById("showPanel").addEventListener('click', event => {
        document.getElementById("panel").style.display = "flex";
        document.getElementById("showPanel").disabled = true;
      });
      document.getElementById("closePanel").addEventListener('click', event => {
        document.getElementById("panel").style.display = "";
        document.getElementById("showPanel").disabled = false;
      });
      //document.getElementById("board_area").requestFullscreen();
    </script>
  </body>
</html>